## Background

Currently, different environments may have different authentication enabled for gateways. If the interface has `user authentication` enabled, the caller needs to provide `user identity` when calling. For details, see [Authentication](./authorization.md)

- User login ticket: bk_token
- access_token: The ticket generated by the application using the user login status

In some scenarios, the caller cannot get the user's login status (scheduled tasks/scripts), or the caller is the backend of a platform system. At this time, if the interface calling the gateway has `user authentication` enabled

Solution: Use the `access_token` service to generate `access_token`

Currently, the access_token interface is provided by bkssm

PS: BlueKing bkauth will take over the internal and external versions of the access_token logic in the future, and all versions will be unified (that is, users do not need to do differentiated development for internal and external versions)

## 1. Generate access_token

> POST /api/v1/auth/access-tokens

### Function description

Generate `access_token`

Note:
- After the system calls the interface to generate `access_token`, it should be saved/cached by itself and shared by multiple instances/multiple processes. In theory, `the same system and the same user` will only generate `access_token` once globally
- Prevent multiple instances/multiple processes of the system from simultaneously initiating the generation of `access_token` for the `same user`. If it is not shared, the later generation will flush the previously generated `access_token`, resulting in verification failure.

### Request parameters

#### Header parameters

| Field | Type | Required | Description |
|-----------|------------|--------|------------|
| X-Bk-App-Code | String | Yes | Application ID |
| X-Bk-App-Secret | String | Yes | Application Token |

#### Interface parameters

| Field | Type | Required | Description |
|-----------|------------|--------|------------|
| grant_type | String | Yes | Authorization type, currently supports authorization_code login authorization and client_credentials client authorization |
| id_provider | String | Yes | Token provider, when grant_type=authorization_code, the value is bk_login; when grant_type=client_credentials, the value is client |
| bk_token | String | No | When Required when grant_type=authorization_code |

### Request parameter example

Use login state `bk_token` to exchange for `access_token`

```json
{
"grant_type": "authorization_code",
"id_provider": "bk_login",
"bk_token": "BhtTaCXsk2MFijI9q_zZ8aWMZz8F6K-QlsdP0IgGrdQ"
}
```

No login state, use `client_credentials`

```json
{
"grant_type": "client_credentials",
"id_provider": "client"
}
```

### Return result example

```json
{
"code": 0,
"data": {
"access_token": "SWU8C6djjzySI85wln1LADTZRkNAR1",
"expires_in": 43200,
"identity": {
"user_type": "bkuser",
"username": "admin"
},
"refresh_token": "GUmzehUfNLVa2JXtTrOag3e1YsTTdv"
},
"message": "string"
}
```

### Return result parameter description

#### code

- `0` indicates success
- Non-`0` indicates failure
- 1901400 Request parameter is invalid
- 1901401 No permission to call this API
- 1901500 System error

#### data

| Field | Type | Description |
|-----------|-----------|-----------|
| access_token | String | Generated access_token |
| expires_in | Integer | Expiration time, in seconds |
| identity | Object | Object corresponding to token |
| refresh_token | string | refresh_token refreshed by the user |

#### data.identity

| Field | Type | Description |
|-----------|-----------|-----------|
| user_type | string | User type |
| username | string | User name |

## 2. Refresh access_token

> POST /api/v1/auth/access-tokens/refresh

### Function description

Refresh access_token

Note:
- A `refresh_token` can refresh the `access_token` within its validity period (default 30 days)
- After refreshing, the original `access_token` will become invalid
- After refreshing, the `refresh_token` itself will not be updated or renewed
- If a `refresh_token` has expired, you can only regenerate an `access_token`

### Request parameters

#### header parameters

| Field | Type | Required | Description |
|-----------|------------|--------|------------|
| X-Bk-App-Code | String | Yes | Application ID |
| X-Bk-App-Secret | String | Yes | Application Token |

#### interface parameters

| Field | Type | Required | Description |
|-----------|------------|--------|------------|
| refresh_token | String | Yes | Access_token refreshed by the user |

### request parameter example

```python
{
"refresh_token": "GUmzehUfNLVa2JXtTrOag3e1YsTTdv"
}
```

### return result example

```python
{
"code": 0,
"data": {
"access_token": "SWU8C6djjzySI85wln1LADTZRkNAR1",
"expires_in": 43200,
"identity": {
"user_type": "bkuser",
"username": "admin"
},
"refresh_token": "GUmzehUfNLVa2JXtTrOag3e1YsTTdv"
},
"message": "string"
}
```

### Return result parameter description

#### code

- `0` indicates success
- Non-`0` indicates failure
- 1901400 Request parameters are invalid
- 1901401 No permission to call this API
- 1901403 RefreshToken is invalid or expired
- 1901500 System error

#### data

| Field | Type | Description |
|-----------|-----------|-----------|
| access_token | string | access_token after refresh|
| expires_in | integer | expiration time, in seconds |
| identity | object | object corresponding to token |
| refresh_token | string | refresh_token for this refresh. Note that refresh_token will not be updated or renewed and can only be refreshed within the validity period |

#### data.identity

| field | type | description |
|-----------|-----------|-----------|
| user_type | string | user type |
| username | string | user name |