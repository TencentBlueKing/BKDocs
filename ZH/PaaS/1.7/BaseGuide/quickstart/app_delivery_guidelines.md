## 蓝鲸应用开发交付规范

为了方便开发者，蓝鲸 PaaS 平台提供了访问路由、日志监控、增强服务等诸多“开箱即用”的功能。

不过，并非任意应用都能使用这些平台功能。举个简单的例子，开发者想在平台上部署开源的 [httpbin](https://hub.docker.com/r/kennethreitz/httpbin/) 服务，在不做任何改动的情况下，是无法成功的——进程不能正常提供 HTTP 服务。这是由于，httpbin 镜像的默认端口号配置，没有适配蓝鲸 PaaS 平台的访问路由规则。

正因如此，开发者必须确保在开发和配置阶段，**严格遵守蓝鲸 PaaS 平台的应用开发交付规范**，方能正常使用平台的各项功能。本文档将对规范内容进行详细说明。

 > **Tip**：蓝鲸 PaaS 平台上的大部分应用基于开发框架（Python/Go 等语言）开发，它们默认就是“符合规范”的。需要开发者额外确保符合规范的应用，主要是以下几类：
> 
> - 基于源码构建，**但未使用蓝鲸开发框架**：平台基于源码构建镜像
> - 基于 Dockerfile 构建：平台基于仓库 Dockerfile 文件构建镜像
> - 提供镜像仓库：平台直接从远程仓库获取镜像

### 规范正文

#### 进程监听端口

为保证用户请求能被正常处理，镜像的进程需要符合平台的访问路由规范，监听正确的端口号。

简单介绍一下请求处理原理：

1. 用户请求发往应用域名的 80（或 443） 端口，之后转发到模块内；
2. 每个模块可能存在多个进程，每个进程都可配置一批端口映射规则；
3. 开发者可将其中一条映射规则设置为“访问入口”（模块内唯一）；
4. 用户请求最终遵守“访问入口”，发往规则所属进程的“容器端口”。

因此，只有当进程实际监听的端口，匹配“访问入口”规则的容器端口号时，请求链路才是畅通的。要达成这一点，共有两种配置方法：

1. 调整规则端口：访问开发者中心的“模块配置”->“进程配置”页面，修改“端口映射”中被设置为“访问入口”规则的容器端口号，以完成匹配；
2. 调整进程监听端口：调整“命令参数”，改变进程实际监听的端口号以完成匹配。

> 注：基于源码构建的模块，无法在产品页上修改端口规则和命令参数，需要通过修改仓库中的应用描述文件（`app_desc.yaml`）来完成，详情参阅产品页指南。

举个例子，应用 A 通过仓库的 Dockerfile 文件构建镜像，将其部署到开发者中心后，无法正常访问。此时，web 进程所使用的启动命令为 `/serve`，命令参数为 `--port 8083`——通过 Dockfile 的 `CMD` 命令配置（`CMD ["./serve", "--port", "8083"]`）。

要修复应用 A 的访问问题，有 3 种方式：

1. 访问“进程配置”页面，将其中“访问入口”规则的“容器端口”修改为 `8083`，保存后重新部署
2. 访问“进程管理”页面，将“命令参数”修改为 `--port {“容器端口”字段值}`（“访问入口”规则的“容器端口”值），保存后重新部署
3. 修改 `Dockerfile` 文件，将 `CMD ["./serve", "--port", "8083"]` 中的端口号 8083，调整为“访问入口”规则“容器端口”中所配置的值，如 `5000`

总而言之，关键是让进程配置中的端口号匹配实际监听的端口号，各方法可灵活选用。

#### 进程日志文件格式与路径

应用的日志一共分为两类：

1. 标准输出日志、访问日志
2. 结构化日志

第 1 类日志由平台自动采集，包含进程的标准输出（stdout 或 stderr）和接入层访问日志（access log）。此类日志无需开发者额外配置，应用成功部署后可在页面上直接查询。

第 2 类日志是结构化日志，可包含用户自定义的任意内容。此类日志需应用进程主动写入到文件中，由开发者中心清洗、采集。**为了确保功能正常，应用进程写日志文件时，需要严格遵循以下规范：**

- 文件路径：存放在 `/app/v3logs/` 目录中
- 文件名：符合规则 `${process-type}-${随机数}-${stream}.log`
- 文件格式：每一行为完整的 `JSON` 格式，非此格式的内容会被忽略

举个例子，应用 A 把调用云 API 的请求日志记录到了日志文件中。为了让平台将其正常采集为“结构化日志”，开发者可选择将日志输出到文件 `/app/v3logs/web-oZbs-component.log` 中。

示例的有效文件内容如下：

```plain
{"levelname": "INFO", "asctime": "2024-01-11 13:21:50,511", "pathname": "/app/backends.py", "lineno": 77, "funcName": "foo", "message": "request to cloud api finished."}
```

**说明**：如需自定义日志采集/清洗规则、使用日志导出等功能，需要部署“蓝鲸日志平台”。

#### 平台增强服务

为了让应用进程可以正常访问和使用平台提供的增强服务，应用代码需要遵循以下规范。

- 由代码读取并使用环境变量中与增强服务相关的 Key
- 如果该配置项可能有其他来源，优先使用环境变量中的值

举个例子，当应用启用 MySQL 增强服务后，平台会往应用运行环境注入相关的环境变量。这些环境变量包含 `MYSQL_HOST`、`MYSQL_USER` 和 `MYSQL_PASSWORD` 等。详细变量名可在“模块配置”->“增强服务” Tab 中查询。

示例代码如下：

```python
# file: settings.py
import os

# 尝试从环境变量中获取用户名，该变量由蓝鲸 PaaS 平台注入
# 当环境变量不存在时，使用 “localhost”替代
db_host = os.environ.get('MYSQL_HOST') or "localhost"
```