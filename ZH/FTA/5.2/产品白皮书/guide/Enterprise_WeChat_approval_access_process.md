# 故障自愈，企业微信审批接入流程

需要提前准备：

1. 需要先配置企业微信，注册链接：https://work.weixin.qq.com/ ，注意：开启微信端口 80443
2. 蓝鲸故障自愈 APP 已经正常运行 创建故障自愈 APP 请参照[微信审批接入流程](./WeChat_approval_access_process.md)。

微信审批分两种，一种是回复指令审批，适合组合套装中的【通知或审批】套餐，还有一种需要在微信页面审批(通过菜单进入)，适合告警收敛的【异常防御需审批】。这些都需要一个应用为载体，下面以故障自愈应用为例，指引接入审批流程，相关参数可按照配置自行修改。

## 第一步：配置企业微信
1. 绑定企业微信，进入企业微信开放平台 https://work.weixin.qq.com/ ，
   手机企业微信扫码登录(前提必须管理员授权为分支管理员)
2. 登录后切换到【应用与小程序】找到‘蓝鲸 PaaS 测试’，这里以‘蓝鲸 PaaS 测试’为例，请使用自行创建的故障自愈 APP
![Alt text](../assets/20181211001.png)
3. 打开环境中开发者中心-->API 文档-->通道管理-->微信通道配置-->需要设置三个参数，分别为：wx_type，wx_qy_corpid，wx_qy_corpsecret，wx_qy_agentid
4. 参数 1：wx_type:选择企业微信，参数 2：wx_qy_corpid 切换到【我的企业】页面中的企业 ID，参数 3，4：切换到【应用与小程序，点击‘蓝鲸 PaaS 测试’】

![Alt text](../assets/20181211002.png)

![Alt text](../assets/20181211003.png)

![Alt text](../assets/20181211004.png)

5.企业微信开放平台权限管理登录，点击‘企业微信授权登录’将域名回调设置为自己环境的 paas 域名：端口

![Alt text](../assets/20181211005.png)

6.个人中心绑定微信
企业版中，配置了微信通道之后才会在个人中心显示‘绑定微信’，社区版个人中心中显示，点击绑定微信，就会跳转新页面，出现企业维信二维码，使用手机端企业微信扫码后，配置无误的话，绑定成功。

## 第二步：配置自愈套餐

1.	创建审批套餐

![Alt text](../assets/20181211121143.png)

1.1	在接入自愈流程中，告警类型选择 REST 默认分类，这里选择 REST 默认分类是为了方便触发告警，实际使用过程中，请根据自己实际需求选择告警类型。

![Alt text](../assets/20181211123915.png)

1.2	触发告警

完整流程请参照[REST API 推送](../functions/Integrated_RestAPI_Push.md)。


2， 审批套餐执行详情

根据通知内容回复同意与驳回的相应代码。如：同意回复：TY 数字 ， 驳回：BH 数字 (注意：数字是用来指定某一条，数据太多时，无法判断回复的是哪一条，故用数字区分，字母和数字之间有空格，必须带上)

![Alt text](../assets/20181211006.png)

操作同意或者驳回后，会收到自愈成功/失败的通知，同意则成功，驳回则失败

![Alt text](../assets/20181211007.png)

回到故障自愈中，查看自愈详情，审批套餐的状态显示为绿色的勾勾/红色的叉叉(驳回情况)，自愈结果显示为 同意(微信审批)

![Alt text](../assets/201812112115.png)


