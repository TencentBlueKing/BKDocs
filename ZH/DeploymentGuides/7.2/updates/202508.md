
# 20250801

## 持续集成平台

### bk-ci-3.0.15-alpha.4

这是 **安全更新**，修复了安全问题，请尽快安排更新。
<!-- 版本日志见 GitHub_URL 。-->

登录到 **中控机**，先更新 helm 仓库缓存：
``` bash
helm repo update
```
检查仓库里的版本：
``` bash
helm search repo bk-ci --version 3.0.15-alpha.4
```
预期输出如下所示：
>``` plain
>NAME            CHART VERSION   APP VERSION  DESCRIPTION
>blueking/bk-ci  3.0.15-alpha.4  略           略
>```

接下来开始升级了。

先进入工作目录：
``` bash
cd $INSTALL_DIR/blueking/  # 进入工作目录
```

修改 `environments/default/version.yaml` 文件，配置 bk-ci charts version 为 `3.0.15-alpha.4`：
``` bash
sed -i 's/bk-ci:.*/bk-ci: "3.0.15-alpha.4"/' environments/default/version.yaml
grep bk-ci environments/default/version.yaml  # 检查修改结果
```
预期输出：
>``` yaml
>  bk-ci: "3.0.15-alpha.4"
>```

本次更新引入了 JWT 认证功能，并调整了构建容器的 namespace。详细文档见 《[部署蓝盾平台-启用 JWT](install-ci-suite.md#启用%20JWT)》。

可直接执行脚本调整配置：
``` bash
bkci_custom_values=./environments/default/bkci/bkci-custom-values.yaml.gotmpl
touch "$bkci_custom_values"
yq -i '.config.bkCiJwtEnable=True' "$bkci_custom_values"
# 如果没有配置rsa private key，则重新生成覆盖。
if [ null = "$(yq e '.config.bkCiJwtRsaPrivateKey' "$bkci_custom_values")" ]; then
  # 原始的RSA私钥，需要为PKCS#8封装。基于私钥生成公钥。
  rsa_private_key=$(openssl genrsa 2048 | openssl pkcs8 -nocrypt -topk8)
  rsa_public_key=$(openssl rsa -pubout <<< "$rsa_private_key")
  # 提取key正文并移除换行。
  rsa_pri_cc=$(awk -v ORS="" '!/^-/' <<< "$rsa_private_key")
  rsa_pub_cc=$(awk -v ORS="" '!/^-/' <<< "$rsa_public_key")
  # yq修改配置文件。
  yq -i ".config.bkCiJwtRsaPrivateKey=\"$rsa_pri_cc\"|.config.bkCiJwtRsaPublicKey=\"$rsa_pub_cc\"" "$bkci_custom_values"
else echo "SKIP: .config.bkCiJwtRsaPrivateKey exist, will not overwrite."
fi
# 提前创建namespace
kubectl create namespace bkci-build
yq -i '.kubernetes-manager.kubernetesManager.builderNamespace="bkci-build"' "$bkci_custom_values"
```

更新 bk-ci：
``` bash
helmfile -f 03-bkci.yaml.gotmpl -l name=bk-ci sync
```

等待命令执行完毕，结尾输出如下即为更新成功：
>``` plain
>UPDATED RELEASES:
>NAME   CHART           VERSION
>bk-ci  blueking/bk-ci  3.0.15-alpha.4
>```

