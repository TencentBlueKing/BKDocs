## Count Distinct

## 典型案例

实时计算 SQL 支持进行分组聚合，针对结果进行`count(distinct(xxx))`，譬如：

![](../../../../assets/dataflow/stream-processing/dataflow-count-distinct.png)

如上图所示，针对每个 30 秒的窗口，对`int_field`每个维度的批次数据，对字段`string_field`的值去重并计数。可形象地用下表表现出来：

输入表：

|      数据时间       | int_field | string_field |
| :-----------------: | :-------: | :----------: |
| 2020-01-01 00:00:00 |     1     |      a       |
| 2020-01-01 00:00:02 |     1     |      a       |
| 2020-01-01 00:00:04 |     1     |      b       |
| 2020-01-01 00:00:10 |     2     |      a       |
| 2020-01-01 00:00:15 |     3     |      b       |
| 2020-01-01 00:00:20 |     4     |      c       |
| 2020-01-01 00:00:31 |    ...    |     ...      |
| 2020-01-01 00:00:35 |    ...    |     ...      |
| 2020-01-01 00:00:36 |    ...    |     ...      |

输出结果：

|      数据时间       | int_field | cn_field |
| :-----------------: | :-------: | :------: |
| 2020-01-01 00:00:00 |     1     |    2     |
| 2020-01-01 00:00:00 |     2     |    1     |
| 2020-01-01 00:00:00 |     3     |    1     |
| 2020-01-01 00:00:00 |     4     |    1     |
|         ...         |    ...    |   ...    |
|         ...         |    ...    |   ...    |

## 优化

Count Distinct 在当前实时计算的性能较差，可针对具体的 SQL 使用进行优化，以上图为例，可以构造如下两个实时计算节点，达到同样的计算效果。

![](../../../../assets/dataflow/stream-processing/dataflow-count-distinct-temp.png)

![](../../../../assets/dataflow/stream-processing/dataflow-count-distinct-new.png)
