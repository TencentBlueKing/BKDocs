# 数据迁移内容总览

**迁移概览**：

1. 3.1 和 3.2 版本存在一个共存情况。没有办法直接进行升级。
2. 提供配置迁移的操作界面。
3. 配置迁移可直接迁移的部分：主机，进程，服务拨测，数据平台相关的监控配置。
4. 不可迁移的部分：脚本，自定义组件，日志采集。
5. 原有的脚本，自定义组件通过插件管理进行插件制作。

## 采集类

### 组件采集

- 组件定义 - 部分支持迁移
  - 在 3.2 版本中对应功能为 **监控配置 - 插件**
  - 内置组件：不支持迁移。请使用 3.2 版本提供的官方插件
  - 自定义组件 Exporter：支持迁移。可通过升级程序，将 Exporter 二进制文件、指标定义导出为 3.2 插件包，但需要自行在页面中导入
- 组件采集实例 - 不支持迁移
  - 在 3.2 版本中对应功能为 **监控配置 - 采集**

### 脚本采集

- 脚本定义 - 支持迁移
  - 在 3.2 版本中对应功能为 **监控配置 - 插件**
  - 可通过升级程序，将脚本内容、指标定义导出为 3.2 插件包，但需要自行在页面中导入
- 脚本采集实例 - 不支持迁移
  - 在 3.2 版本中对应功能为 **监控配置 - 采集**

### 日志采集

- 日志采集定义 - 不支持迁移
- 日志采集实例 - 不支持迁移

### 拨测采集

- 与旧版相比，3.2 版本的拨测采集除了界面改动，功能并无差别
- 支持全量迁移。可通过升级程序，直接将 **拨测节点**、**拨测任务**、 **拨测任务组** 等配置直接迁移到 3.2 版本

## 视图类

### 自定义监控

- 3.2 版本中，自定义监控视图和仪表盘视图合并，统一由 **仪表盘页面** 配置数据视图
- 可通过升级程序直接迁移

- 自定义监控视图分组 - 支持迁移
  - 迁移为 **仪表盘视图分组**
- 自定义监控视图 - 部分支持迁移
  - 迁移为 **仪表盘视图**
  - 数据源为“基础性能”、“拨测采集”、“数据平台”：支持迁移
  - 数据源为“脚本采集”、“组件采集”、“日志采集” 及其他：不支持迁移

### 仪表盘

- 部分支持迁移。可通过升级程序直接迁移

- 数据源为“基础性能”、“拨测采集”、“数据平台”：支持迁移
- 数据源为“脚本采集”、“组件采集”、“日志采集” 及其他：不支持迁移

## 监控配置类

### 策略配置

- 在 3.2 版本中对应功能为 **监控配置 - 策略**
- 部分支持迁移。可通过升级程序直接迁移
- 数据源为“基础性能”、“基础事件”、“拨测采集”、“数据平台”：支持迁移
- 数据源为“脚本采集”、“组件采集”、“日志采集” 及其他：不支持迁移

- 配置了告警范围的监控策略 **暂不支持迁移**

### 通知组配置

- 在 3.2 版本中对应功能为 **监控配置 - 告警组**
- 支持迁移。可通过升级程序直接迁移

### 告警屏蔽配置

- 在 3.2 版本中对应功能为 **监控配置 - 屏蔽**
- 不支持迁移

## 注意事项

为防止迁移后发生数据冲突。在升级页面确定执行数据迁移后，系统将 **强制清除** 该业务下在 3.2 新版本下的使用数据，包括：

- 策略配置
- 告警组配置
- 仪表盘视图配置

# 迁移细节说明

## 自定义监控

- **监控分组** 迁移至 **仪表盘分组**，分组命名为 `自定义监控-{原视图名称}` ，若存在重名，则在名称后增加数字标识，如 `自定义监控-{原视图名称}(1)`

- **监控视图** 迁移至**仪表盘视图**
  - **监控名称** 迁移至 **视图名称**
  - **聚合方法** 迁移至 **聚合方法**
  - **监控周期** 迁移至 **视图周期**
  - **监控维度** 迁移至 **group by**
  - **监控源** 迁移至 **指标项**

- 对于组件、脚本、日志类型的数据源，由于在新版中无对应的指标项，只做一次性迁移，**不支持编辑**

## 策略配置

原有的监控项将一对一迁移至**策略配置**

### 策略名称

- 主机监控：继承为 `{监控名称}`，如 `磁盘使用率`
- 自定义监控：继承为 `{策略名称}`
- 名称中长度超过 50 的部分将被截除

### 监控对象

- 基础性能
  - 进程类指标：主机-进程
  - 其他：主机-操作系统
- 服务拨测
  - 应用 - 服务拨测

### 监控项

- 基础性能、基础事件、服务拨测、数据平台类型的数据源，**支持迁移**
- 组件、脚本、日志类型的数据源，由于在新版中无对应的指标项，因此 **不支持迁移**

### 计算公式

- 继承原有聚合方法

### 监控维度

- 继承原有监控维度

### 监控条件

- 仪表盘配置中若包含 `where` 条件，会一并迁移
- 配置了告警范围的监控策略 **不支持迁移**

### 检测算法

- 分级算法：直接迁移
- 组合算法：直接迁移。但注意在新版中，同种算法只能出现一次，因此对于之前配置了多个同类算法的策略，只做一次性迁移，**不支持编辑**。

### 触发条件

- 直接迁移

### 恢复条件

- 此为新增功能，默认设置为触发条件的周期

### 告警通知模板

- 在新版中，告警模板格式变动较大。不支持迁移

### 无数据告警

- 直接迁移

### 是否进行恢复通知

- 非分级告警：继承原有策略配置中的恢复通知选项
- 分级告警：使用各个级别配置中 **时间跨度最大** 的级别对应的恢复通知配置

### 通知间隔

- 继承原有策略配置中的告警收敛时间

### 通知时间段

- 分级告警：使用各个级别配置中 **跨度最大的时间段** 作为通知时间段配置
- 非分级告警：直接继承原有通知时间段

### 告警组

- 旧版本中通知群组配置将直接迁移到新版，通知方式统一初始化为 **邮件** 和 **微信**
- 通知对象
  - 分级告警：取所有级别的通知角色和电话通知人员的并集
  - 非分级告警：取通知角色和电话通知人员的并集
- 告警组引用
  - 一个策略绑定多个告警组，若 **通知对象** 和 **通知方式** 完全一致时，告警组将会被复用
  - 例如：旧配置中，通知对象为 `主负责人，备份负责人，运维，测试，user1，user2`，在新版将引用为 4 个告警组，分别是 `主备复杂人`，`运维`，`测试`，`user1，user2`
- 通知方式
  - 当设置的通知人为 `主备负责人`，`运维`，`测试`，`开发`，`产品`，或者 `旧版通知群组` 时
    - 通知方式统一为 **邮件** 和 **微信**
  - 其他情况
    - 分级告警：继承原有级别的通知方式，对于未定义的级别，设置为 **最低级别配置** 的通知配置
    - 非分级告警：对所有等级配置原有的通知方式
- 告警组名称
  - 使用通知对象名称进行拼接（如`主负责人，备份负责人，admin`），超过 128 个字符的，进行截断。若发生重名，则增加数字后缀进行区分

### 监控目标

- 主机监控策略：监控目标直接继承原有的 IP 或 CMDB 拓扑节点
- 其他类型的监控策略：监控目标为空

## 脚本采集

- 插件名
  - 继承原配置的 **表名**

- 插件别名
  - 继承原配置的 **中文含义**

- 插件类型
  - 固定为 `Script`
- 支持系统
  - 脚本类型为 `bat`, `powershell`, `vbs`：仅支持 Windows
  - 其他类型：同时支持 Windows 和 Linux
- 脚本内容
  - 继承原配置脚本
- 定义参数
  - 参数类型：位置参数
  - 参数名称和参数说明继承原配置
  - 3.2 版本不支持自定义启动命令，因此 **自定义类型脚本的启动命令不继承**
- 指标维度
  - 分类：base(默认分类)
  - 默认分类下的指标维度全部平移
- 远程采集
  - 默认设为“否”，用户导入后可自行修改
- 分类
  - 默认设为 `其他`，用户导入后可自行修改
- 描述
  - 设置为空

## 组件采集

- 插件名
  - 继承原配置 **组件名称**
- 插件别名
  - 继承原配置 **组件别名**
- 插件类型
  - 固定为 `Exporter`
- 支持系统
  - 根据原配置上传的 Exporter 种类决定
- 定义参数
  - 参数类型：环境变量和命令行参数
  - 参数名称和参数说明继承原配置
- 指标维度
  - 继承原有的指标维度分类
- 远程采集
  - 默认设为“否”，用户导入后可自行修改
- 分类
  - 默认设为 `组件`，用户导入后可自行修改
- 描述
  - 继承原配置 **组件描述**
