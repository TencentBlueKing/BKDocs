# 模板集使用介绍

在 BCS 中，模板集合是 Kubernetes 配置文件模板的集合。您可以通过将多个应用的配置构成一个模板集，来简化服务管理的复杂度；您还可以将模板里面需要频繁修改的数据设置成变量，以方便维护。

![-w2020](../assets/image00.png)

通过『模板集』+『变量』来管理您的业务将非常方便。

## 理解“服务”

如果您的服务由多个应用构成，通过 **模板集** + **变量** 生成 “应用” 来管理您的服务将会非常方便。

为了方便大家理解，本文将以一个简单的 Nginx 服务为例来说明。该服务下只有一个 Nginx 应用，通过修改模板中 **NGINX_PORT** 变量的值，将应用以不同的端口部署到不同的命名空间中。

## 创建模板集
### 推送镜像到仓库

在创建模板前，先通过以下几个步骤将 **Nginx 应用的的镜像推送到蓝鲸容器服务的镜像仓** 库中。

#### 获取镜像的压缩包

在本地执行 `docker save` 获取镜像压缩包，您也可以直接点击下载 [nginx.tar](http://bkopen-1252002024.file.myqcloud.com/bcs/nginx.tar)。

```bash
docker pull nginx
docker save nginx > nginx.tar
```

#### 上传镜像

选中【仓库】菜单的【项目镜像】页面，参考 [Harbor 仓库使用指南](./HarborGuide.md)，通过命令行工具来推送镜像。

### 创建项目模板集

选中【模板集】菜单，点击【添加模板集】。

进入创建模板集页面后，可以在模板集定义 Deployment、Service 等资源，这些资源的详情介绍可以参考 [Deployment 说明文档](./k8s/workload/deployment.md)。本文的案例中我只需要创建一个 Deployment。

首先填入一些基本信息，包括名称、描述，实例数量指最终拉起的实例数。Kubernetes 使用选择器（spec.selector.matchLabels）关联资源，实例化后选择器的值不可变，所以在创建模板的时候需要给应用打一个固定的标签，并且把这个标签添加到选择器中。

点击下方的 Pod 模板设置，将网络策略设置为 Host 模式，可以直接用主机网络，将 Nginx 容器端口对外暴露。

![-w2020](../assets/image0211.png)

接下来定义 Nginx 容器，需要填写名称、描述，选择 Nginx  镜像。同时将容器端口以变量的形式填写，这样可以将应用以不同的端口部署到不同的命名空间中。

![-w2020](../assets/image0311.png)

这样我们的模板集就创建好了，点击上方的保存按钮，将模板集的保存到一个版本中。

![-w2020](../assets/image0411.png)

## 设置变量

选中【变量管理菜单】，统一管理所有的变量，变量分为三类：

- 全局变量：变量的生效范围为整个项目，如系统变量里面的：项目 ID、业务 ID
- 集群变量：变量的生效范围为集群，同一个变量可以针对不同的集群设置不同的值，如系统变量里面的：集群 ID、仓库域名
- 命名空间变量：变量的生效范围为命名空间，同一个变量可以针对不同的命名空间设置不同的值

点击引用处，可以查看所有引用了这个变量的模板的详情。

![-w2020](../assets/image0511.png)

点击批量更新，可以同时对不同的集群、命名空间赋值。

![-w2020](../assets/image0611.png)

## 模板集中引用变量

模板集中可采用`{{变量名}}`的方式引入变量

![-w2020](../assets/image13.png)

![-w2020](../assets/image14.png)

## 创建服务示例

选中【模板集】菜单，点击实例化按钮进入实例化页面，选择模板集、命名空间。变量默认值为在上一步设置的值，您也可以在实例化页面修改这个值。最后点击创建就完成了实例化操作。

![-w2020](../assets/image07.png)

## 确认完成

应用部署完成后，您可以在容器服务左侧导航中点击“应用”，查看 Nginx 服务应用实例，并可以通过 Host IP 和配置的容器端口访问服务。

![-w2020](../assets/image08.png)

### 滚动升级

您可以通过配置不同的模板集版本来实现滚动升级的功能。

#### 节点设置标签

通过节点设置标签，可以在调度的时候将应用调度到固定的主机上。本例中将集群节点中的一台主机添加`app:nginx`的标签。

![-w2020](../assets/image09.png)

#### 新增模板集版本

在模板集的调度约束中，将 `NodeSelector` 设置为`app:nginx`，并保存到一个新的版本中。

![-w2020](../assets/image10.png)

#### 滚动升级

在应用页面，点击滚动升级并选择最新的版本，可以页面上查看滚动升级前后的配置文件差异，点击确定将应用滚动升级到新版本。

![-w2020](../assets/image11.png)

进入应用的详情页面，可以发现 Nginx 应用已经被重新调度到了设置了`app:nginx`标签的主机上，并可以通过新的 Host IP 和配置的容器端口访问 Nginx 服务。

![-w2020](../assets/image12.png)

## 附录
### 节点标签说明文档

- K8S

节点标签主要是一组绑定到 K8S 资源对象上的 key/value 对。通过给指定的资源对象捆绑一个或多个不同的 label 来实现多维度的资源分组管理功能，以便于灵活，方便地资源分配，调度，配置，部署等管理工作。
